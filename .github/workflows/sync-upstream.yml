name: Sync Fork with Upstream

on:
  # Run automatically every day at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual triggering of the workflow
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history to ensure proper sync
          fetch-depth: 0
          # Use a token that has write permissions to your repository
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/vllm-project/vllm.git
          git fetch upstream
      
      - name: Sync main branch
        run: |
          # Switch to main branch (or master, depending on your default branch)
          git checkout main
          
          # Merge upstream changes
          git merge upstream/main --no-edit
          
          # Push the updated main branch
          git push origin main
      
      - name: Create Pull Request for conflicts (if any)
        if: failure()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Sync fork with upstream vllm-project/vllm"
          title: "ðŸ”„ Sync fork with upstream"
          body: |
            This PR was automatically created to sync the fork with upstream changes.
            
            **Upstream Repository**: https://github.com/vllm-project/vllm
            
            There may be merge conflicts that need to be resolved manually.
            Please review the changes carefully before merging.
            
            ---
            _This PR was created automatically by the sync-upstream workflow._
          branch: sync-upstream-${{ github.run_number }}
          delete-branch: true

      - name: Summary
        if: success()
        run: |
          echo "âœ… Successfully synced fork with upstream vLLM repository"
          echo "ðŸ“Š Latest commit from upstream has been merged into main branch" 